<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ThorVG Canvas Kit WASM Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        #canvas {
            border: 1px solid #333;
            background: white;
            margin: 20px 0;
        }
        .controls {
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .info {
            background: #fff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ThorVG Canvas Kit WASM Example</h1>

    <div class="info">
        <h3>Canvas Kit API Features:</h3>
        <ul>
            <li>C++ & CAPI Hybrid build: leverage C API for less maintenance, C++ helper handles GL/WG bring-up to cut boundary overhead</li>
            <li>Uniform API across SW/GL/WG backends lets you ship one client code path no matter which binary you build</li>
            <li>Strict type safety and native-side init/teardown make it feel like a native engine for JS developers</li>
            <li>WebGPU path runs without asyncify, keeping binaries lean even with advanced GPU features enabled</li>
        </ul>
    </div>

    <div class="controls">
        <label>Backend:
            <select id="backend">
                <option value="sw">Software</option>
                <option value="gl">WebGL</option>
                <option value="wg">WebGPU</option>
            </select>
        </label>
        <button onclick="init()">Initialize</button>
        <button onclick="drawShapes()">Draw Shapes</button>
        <button onclick="clearCanvas()">Clear</button>
    </div>

    <canvas id="canvas" width="800" height="600"></canvas>

    <div class="info">
        <h3>Status:</h3>
        <pre id="log"></pre>
    </div>

    <script type="module">
        import ThorVGModule from '../build_wasm_canvaskit/src/bindings/wasm/thorvg-canvaskit.js';

        let TVG;
        let engine;
        let canvasPtr = 0;

        function log(msg) {
            const logEl = document.getElementById('log');
            logEl.textContent += msg + '\n';
            console.log(msg);
        }

        async function loadModule() {
            log('Loading ThorVG Canvas Kit module...');
            TVG = await ThorVGModule();
            log('Module loaded successfully!');
        }
        
        let status;
        let attempts = 0;
        async function initModule(renderer) {
          // Initialize Canvas Kit (handles WebGPU async init internally)
          log('Initializing Canvas Kit...');

          if (renderer !== 'wg') {
            //NOTE: thorvg software/webgl renderer doesn't do anything in the module init(). Skip ASAP.
            return;
          }
          
          do {
              status = TVG.init();
              if (status === 2) {
                  log(`  Waiting for initialization... (attempt ${++attempts})`);
                  await new Promise(r => setTimeout(r, 100));
              }
          } while (status === 2 && attempts < 50);

          if (status !== 0) {
              log('ERROR: Canvas Kit initialization failed!');
              return;
          }
          log('Canvas Kit initialized successfully!');
        }

        function applyRendererFromQuery() {
            const params = new URLSearchParams(window.location.search);
            const renderer = params.get('renderer');
            if (!renderer) return;

            const backendSelect = document.getElementById('backend');
            if (['sw', 'gl', 'wg'].includes(renderer)) {
                backendSelect.value = renderer;
            }
        }

        function setupRendererChangeHandler() {
            const backendSelect = document.getElementById('backend');
            backendSelect.addEventListener('change', () => {
                const renderer = backendSelect.value;
                const url = new URL(window.location.href);
                url.searchParams.set('renderer', renderer);
                window.location.href = url.toString();
            });
        }

        window.init = async function() {
            if (!TVG) {
                await loadModule();
            }

            const backend = document.getElementById('backend').value;
            log(`Initializing with ${backend} backend...`);

            await initModule(backend);

            // Create engine wrapper
            engine = new TVG.ThorVGEngine();

            // Create canvas with engine-specific initialization
            const selector = '#canvas';
            canvasPtr = engine.createCanvas(backend, selector, 800, 600);
            console.log('canvasPtr', canvasPtr);

            if (canvasPtr === 0) {
                log('ERROR: Failed to create canvas!');
                return;
            }

            log(`Canvas created successfully! (ptr: ${canvasPtr})`);
            log('Ready to draw!');
        };

        window.drawShapes = function() {
            if (canvasPtr === 0) {
                log('ERROR: Canvas not initialized. Click Initialize first!');
                return;
            }

            log('Drawing shapes...');

            // Draw a red rectangle (direct C API call)
            const rect = TVG._tvg_shape_new();
            TVG._tvg_shape_append_rect(rect, 0, 0, 200, 150, 10, 10, 1);
            TVG._tvg_shape_set_fill_color(rect, 255, 0, 0, 255);
            TVG._tvg_paint_translate(rect, 100, 100);
            TVG._tvg_canvas_push(canvasPtr, rect);

            // Draw a blue circle with stroke
            const circle = TVG._tvg_shape_new();
            TVG._tvg_shape_append_circle(circle, 0, 0, 80, 80, 1);
            TVG._tvg_shape_set_fill_color(circle, 0, 100, 255, 255);
            TVG._tvg_shape_set_stroke_width(circle, 5);
            TVG._tvg_shape_set_stroke_color(circle, 0, 0, 0, 255);
            TVG._tvg_paint_translate(circle, 500, 200);
            TVG._tvg_canvas_push(canvasPtr, circle);

            // Draw a green rectangle
            const rect2 = TVG._tvg_shape_new();
            TVG._tvg_shape_append_rect(rect2, 0, 0, 150, 100, 0, 0, 1);
            TVG._tvg_shape_set_fill_color(rect2, 0, 200, 100, 255);
            TVG._tvg_paint_translate(rect2, 300, 400);
            TVG._tvg_canvas_push(canvasPtr, rect2);

            // Render
            TVG._tvg_canvas_draw(canvasPtr, 1);
            TVG._tvg_canvas_sync(canvasPtr);

            log('Drawing complete!');

            // For SW backend, copy buffer to canvas
            const backend = document.getElementById('backend').value;
            if (backend === 'sw') {
                const buffer = engine.render();
                const size = engine.size();
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                const imageData = new ImageData(
                    new Uint8ClampedArray(buffer),
                    size.width,
                    size.height
                );
                ctx.putImageData(imageData, 0, 0);
                log('Buffer copied to canvas!');
            }
        };

        window.clearCanvas = function() {
            if (!engine) {
                log('ERROR: Engine not initialized!');
                return;
            }

            // Clear ThorVG canvas (removes all paints)
            engine.clear();
            TVG._tvg_canvas_draw(canvasPtr, 1);
            TVG._tvg_canvas_sync(canvasPtr);

            // For SW backend, also clear the HTML canvas
            const backend = document.getElementById('backend').value;
            if (backend === 'sw') {
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            log('Canvas cleared!');
        };

        // Auto-load module on page load
        applyRendererFromQuery();
        setupRendererChangeHandler();
        loadModule();
    </script>
</body>
</html>
